name: STAGE - CI/CD for App Connoisseur Version 2

permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:  # Trigger manually if needed, or you can use push to main
    inputs:
        app:
          description: 'App to build and deploy (e.g., fluent, fast, express, act)'
          required: true
        service:
          description: 'Service to Build (e.g., fluent-widget, fluent-flask)'
          required: true
        version:
          description: 'Service version'
          required: true
          default: 'latest'

jobs:
  build-and-deploy:
    runs-on: staging

    # strategy:
    #   matrix:
    #     app: [fluent,fast,express,act]  # You can extend to other apps (app1, app2, etc.)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # - name: Set up Docker Buildx
    #   uses: docker/setup-buildx-action@v2

    # Build the Docker image only for the specified service
    - name: Build Docker Image for Service
      run: |
        echo "Building service: ${{ github.event.inputs.service }}"
        chmod +x ./build-service.sh
        ./build-service.sh ${{ github.event.inputs.service }} --version=${{ github.event.inputs.version }}

    # Update service images in stack.yml
    - name: Update stack.yaml with new images
      run: | 
        if [ "${{ github.event.inputs.service }}" = "fluent" ]; then
          # Update both fluent and fluent-worker images
          sed -i "s|image: fluent:.*|image: fluent:${{ github.event.inputs.version }}|" ${{ github.event.inputs.app }}-stack/stage.yaml
          sed -i "s|image: fluent-worker:.*|image: fluent-worker:${{ github.event.inputs.version }}|" ${{ github.event.inputs.app }}-stack/stage.yaml
        else
          # Update only the specified service image
          sed -i "s|image: ${{ github.event.inputs.service }}:.*|image: ${{ github.event.inputs.service }}:${{ github.event.inputs.version }}|" ${{ github.event.inputs.app }}-stack/stage.yaml
        fi

    # Configure Git, Commit, and Push
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Commit stack.yaml changes
      run: |
        git checkout -b STAGE-${{ github.event.inputs.service }}-${{ github.event.inputs.version }}
        git add ${{ github.event.inputs.app }}-stack/stage.yaml
        if [ "${{ github.event.inputs.service }}" = "fluent" ]; then
          git commit -m "Update images for fluent (web + worker) to ${{ github.event.inputs.version }}"
        else
          git commit -m "Update image for ${{ github.event.inputs.service }} to ${{ github.event.inputs.version }}"
        fi

    - name: Push changes to new branch
      run: |
        git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} HEAD:STAGE-${{ github.event.inputs.service }}-${{ github.event.inputs.version }}
    
    # Create a Pull Request
    # - name: Create Pull Request
    #   uses: peter-evans/create-pull-request@v7
    #   with:
    #     token: ${{ secrets.PAT_TOKEN }}
    #     branch: update-image-${{ github.sha }}
    #     committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
    #     author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
    #     signoff: false
    #     title: "Update image for ${{ github.event.inputs.service }}"
    #     body: "This PR updates the image for ${{ github.event.inputs.service }} to ${{ github.sha }}."
    #     base: main

    # Optionally deploy the updated stack or service
    - name: Deploy updated service
      run: |
        docker stack deploy -d -c ${{ github.event.inputs.app }}-stack/stage.yaml ${{github.event.inputs.app}}-stack

    # Optional: Clean up Docker
    #- name: Clean up Docker
    #  run: docker system prune -f
