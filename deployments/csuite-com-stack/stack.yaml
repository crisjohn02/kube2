services:
  redirect:
    image: nginx:1.29.4-alpine3.23
    networks:
        - web2
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 10s
        max_failure_ratio: 0.1
      restart_policy: 
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.csuitecom.rule=Host(`connoisseur-suite.com`)
        - traefik.http.routers.csuitecom.entrypoints=websecure
        - traefik.http.routers.csuitecom.tls=true
        - traefik.http.routers.csuitecom.tls.certresolver=production
        - traefik.http.services.csuitecom.loadbalancer.server.port=80
        - traefik.http.routers.csuitecom.middlewares=redirect-to-new-domain
        - "traefik.http.middlewares.redirect-to-new-domain.redirectregex.regex=^https?://connoisseur-suite.com/(.*)"
        - "traefik.http.middlewares.redirect-to-new-domain.redirectregex.replacement=https://connoisseur-suite.co.uk/$$1"
        - traefik.http.middlewares.redirect-to-new-domain.redirectregex.permanent=true

  redirect2:
    image: nginx:1.29.4-alpine3.23
    networks:
        - web2
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        monitor: 10s
        max_failure_ratio: 0.1
      restart_policy: 
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.splitsecondresearch.rule=Host(`splitsecondresearch.com`)
        - traefik.http.routers.splitsecondresearch.entrypoints=websecure
        - traefik.http.routers.splitsecondresearch.tls=true
        - traefik.http.routers.splitsecondresearch.tls.certresolver=production
        - traefik.http.services.splitsecondresearch.loadbalancer.server.port=80
        - traefik.http.routers.splitsecondresearch.middlewares=redirect-to-new-domain-ssr
        - "traefik.http.middlewares.redirect-to-new-domain-ssr.redirectregex.regex=^https?://splitsecondresearch.com/(.*)"
        - "traefik.http.middlewares.redirect-to-new-domain-ssr.redirectregex.replacement=https://splitsecondresearch.co.uk/$$1"
        - traefik.http.middlewares.redirect-to-new-domain-ssr.redirectregex.permanent=true

networks:
  web2:
    external: true