# MariaDB Galera Helm Values
#
# SWARM EQUIVALENT: You don't have clustered MariaDB in Swarm.
# This is an upgrade - 3 nodes, multi-master, synchronous replication.
#
# Galera Cluster means:
#   - ALL 3 nodes accept reads AND writes (multi-master)
#   - Data is synchronously replicated (no data loss on failover)
#   - Lose 1 node? Other 2 keep serving. Zero downtime maintenance.
#
# Install with:
#   helm install mariadb bitnami/mariadb-galera -n databases -f helm-values.yaml
#
# The Helm chart creates:
#   - StatefulSet: mariadb-galera-0, mariadb-galera-1, mariadb-galera-2
#   - Service: mariadb-galera.databases.svc (load-balances across all nodes)
#   - PVCs: 3 x 8Gi persistent volumes (one per node)
#   - Secrets: auto-generated from passwords below
#
# IMPORTANT: Apply the Secret first, then install the Helm chart:
#   kubectl apply -f databases/mariadb/secret.yaml - to create the secret

# To install MariaDB operator, run:
# helm repo add mariadb-operator https://helm.mariadb.com/mariadb-operator - to add the repository
# kubectl create namespace databases
# helm install mariadb-operator-crds mariadb-operator/mariadb-operator-crds - to install the CRDs
# helm install mariadb-operator mariadb-operator/mariadb-operator - to install the operator
# helm install mariadb-cluster mariadb-operator/mariadb-cluster --namespace databases --create-namespace -f databases/mariadb/helm-values.yaml - to install the cluster

# In the following example the referenced secrets are managed externally.
mariadb:
  rootPasswordSecretKeyRef:
    name: mariadb-secret
    key: MARIADB_ROOT_PASSWORD
    generate: false
  storage:
    size: 1Gi
  myCnf: |
    [mariadbd]
    # --- Connections ---
    max_connections           = 500
    wait_timeout              = 300
    interactive_timeout       = 300
    max_allowed_packet        = 64M

    # --- InnoDB (the main storage engine) ---
    innodb_buffer_pool_size   = 512M
    innodb_log_file_size      = 128M
    innodb_flush_log_at_trx_commit = 2
    innodb_flush_method       = O_DIRECT
    innodb_file_per_table     = ON
    innodb_io_capacity        = 400
    innodb_io_capacity_max    = 800

    # --- Query performance ---
    tmp_table_size            = 64M
    max_heap_table_size       = 64M
    join_buffer_size          = 2M
    sort_buffer_size          = 2M
    read_buffer_size          = 1M
    read_rnd_buffer_size      = 1M
    table_open_cache          = 2000
    thread_cache_size         = 50

    # --- Slow query log (debug performance issues) ---
    slow_query_log            = ON
    long_query_time           = 2

    # --- Character set ---
    character-set-server      = utf8mb4
    collation-server          = utf8mb4_unicode_ci

    # --- Galera-specific tuning ---
    binlog_format             = ROW
    innodb_autoinc_lock_mode  = 2
    wsrep_slave_threads       = 4

  replicas: 3
  galera:
    enabled: true
  # tls:
  #   enabled: true
  #   autoGenerated: true
  # metrics:
  #   enabled: true
databases:
  - name: fluent
    characterSet: utf8
    collate: utf8_general_ci
    cleanupPolicy: Delete
    requeueInterval: 10h
    retryInterval: 30s
  - name: timesheet
    characterSet: utf8
    collate: utf8_general_ci
    cleanupPolicy: Delete
    requeueInterval: 10h
    retryInterval: 30s
users:
  - name: root
    passwordSecretKeyRef:
      name: mariadb-secret
      key: MARIADB_PASSWORD
    host: "%"
    cleanupPolicy: Delete
    requeueInterval: 10h
    retryInterval: 30s
grants:
  - name: root
    privileges:
      - "ALL PRIVILEGES"
    database: "*"
    table: "*"
    username: root
    grantOption: true
    host: "%"
    cleanupPolicy: Delete
    requeueInterval: 10h
    retryInterval: 30s
physicalBackups:
  - name: physicalbackup
    schedule:
      cron: "0 0 * * *"
      suspend: false
      immediate: true
    compression: gzip
    maxRetention: 720h
    storage:
      volume:
        persistentVolumeClaim:
          claimName: databases-backups
# physicalBackups:
#   - name: physicalbackup
#     schedule:
#       cron: "0 0 * * *"
#       suspend: false
#       immediate: true
#     compression: gzip
#     maxRetention: 720h
#     storage:
#       s3:
#         bucket: physicalbackups
#         prefix: mariadb
#         endpoint: minio.minio.svc.cluster.local:9000
#         region:  us-east-1
#         accessKeyIdSecretKeyRef:
#           name: minio
#           key: access-key-id
#         secretAccessKeySecretKeyRef:
#           name: minio
#           key: secret-access-key
#         tls:
#           enabled: true
#           caSecretKeyRef:
#             name: minio-ca
#             key: ca.crt
